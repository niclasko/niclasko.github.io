importScripts("moment.min.js","timer.js");for(var chars="abcdefghijklmnopqrstuvwxyz\u00e6\u00f8\u00e5",charPositions={},i=0;i<chars.length;i++)charPositions[chars.charAt(i)]=i;var MAX_INT=9007199254740992,MIN_INT=-9007199254740992,LF="\n",CR="\r",CRLF="\r\n",_LF=0,_CR=1,_CRLF=2,jsimdb=new jsIMDB;
onmessage=function(a){if("sample"==a.data.action)a=jsimdb.sample(a.data.file),postMessage({reply:"sample",fileSample:jsimdb.fileSample,lineSeparator:jsimdb.lineSeparator,fieldSeparatorSuggestion:jsimdb.fieldSeparatorSuggestion,file:a});else if("compress"==a.data.action)jsimdb.initialize(a.data.fieldSeparator,a.data.dimensionOrFactSpec,a.data.file),jsimdb.compress(a.data.file),postMessage({reply:"done_compressing",jsimdb:{header:jsimdb.header,recordCount:jsimdb.recordCount,fieldSpec:jsimdb.fieldSpec,
DIM:jsimdb.DIM,FACT:jsimdb.FACT,DATE:jsimdb.DATE,dateInfoFields:jsimdb.dateInfoFields(),reversedDictionary:jsimdb.datesReversedDictionary,datesReversedDictionary:jsimdb.datesReversedDictionary,reversedDictionaryToDatesReversedDictionaryLookup:jsimdb.reversedDictionaryToDatesReversedDictionaryLookup,dateInfoReversedDictionary:jsimdb.dateInfoReversedDictionary}});else if("query"==a.data.action){var b=jsimdb.query(a.data.fields,a.data.filters,a.data.outputType);postMessage({reply:"query_done",query_results:b.resultSet,
resultSetRowCount:b.resultSetRowCount,outputType:a.data.outputType})}else"listAllData"==a.data.action?(b=jsimdb.listAllData(),postMessage({reply:"listAllDataDone",output:b})):"getDictionary"==a.data.action?postMessage({reply:"dictionaryListing",fieldName:a.data.fieldName,isDateInfoField:!1,dictionary:jsimdb.reversedDictionary[a.data.fieldName]}):"getDateInfoDictionary"==a.data.action?postMessage({reply:"dictionaryListing",fieldName:a.data.fieldName,isDateInfoField:!0,dateInfoFieldName:a.data.dateInfoFieldName,
dictionary:jsimdb.getDateInfoDictionary(a.data.fieldName,a.data.dateInfoFieldName)}):"binValue"==a.data.action?postMessage({reply:"binValue",fieldName:"percentile"==a.data.binType?jsimdb.binValue(a.data.field,a.data.binCount):"equi-width"==a.data.binType?jsimdb.equiWidthBinValue(a.data.field,a.data.binCount):"",header:jsimdb.header,fieldSpec:jsimdb.fieldSpec}):"getValueStat"==a.data.action?postMessage({reply:"valueStat",valueStat:jsimdb.getValueStat(a.data.fieldName),fieldName:a.data.fieldName}):
"getSplitPoints"==a.data.action?postMessage({reply:"splitPoints",splitPoints:jsimdb.getSplitPoints(a.data.fieldName,a.data.targetFieldName,a.data.filters),fieldName:a.data.fieldName,targetFieldName:a.data.targetFieldName}):"ID3"==a.data.action?postMessage({reply:"ID3",decisionTreeRoot:jsimdb.ID3(a.data.targetFieldName,a.data.attributes,a.data.filters,1),targetFieldName:a.data.targetFieldName}):"scoreData"==a.data.action?(jsimdb.debug("scoreData message received at worker."),jsimdb.scoreData(a.data.decisionTreeRoot,
a.data.newFieldName),postMessage({reply:"scoreData",header:jsimdb.header,fieldSpec:jsimdb.fieldSpec})):"extractRules"==a.data.action?(b=[],jsimdb.extractRules(a.data.decisionTreeRoot,[],b),b.sort(function(a,b){return a.support<b.support?1:a.support>b.support?-1:0}),postMessage({reply:"extractRules",ruleList:b,targetFieldName:a.data.targetFieldName})):"getDecisionTreeAccuracy"==a.data.action?(b=jsimdb.getDecisionTreeAccuracy(a.data.decisionTreeRoot,a.data.targetFieldName),postMessage({reply:"decisionTreeAccuracy",
accuracyInfo:b,targetFieldName:a.data.targetFieldName})):"getPercentilesByTarget"==a.data.action?postMessage({reply:"percentilesByTarget",payload:jsimdb.getPercentilesByTarget(a.data.valueFieldName,a.data.targetFieldName,a.data.filters,a.data.bins)}):"addDimension"==a.data.action?(b=jsimdb.addDimension(a.data.fieldName),0<=b&&jsimdb.addDimensionValue(a.data.fieldName,a.data.blankValue),postMessage({reply:"addDimension",fieldName:a.data.fieldName,header:jsimdb.header,fieldSpec:jsimdb.fieldSpec,status:0<=
b?"OK":"Dimension field name already exists."})):"setFieldValue"==a.data.action?(b=jsimdb.setValueForDimension(a.data.fieldName,a.data.fieldValue,a.data.filters),postMessage({reply:"setFieldValue",fieldName:a.data.fieldName,fieldValue:a.data.fieldValue,isNew:b})):"wordBagFilter"==a.data.action&&(b=jsimdb.addWordBagDictionary(a.data.fieldName),postMessage({reply:"dictionaryListing",fieldName:a.data.fieldName+" (bag of words)",dictionary:b}))};
function jsIMDB(){this.timer=new Timer;this.recordCount=0;this.keyCodes;this.values;this.valueStats;this.compressedDataToRawDataIndexes;this.dimensionIndexToHeader;this.measureIndexToHeader;this.header;this.headerNameToHeaderIndex;this._DimensionOrFactSpec;this.fieldSpec;this.dictionary;this.reversedDictionary;this.dictionaryLengths;this.datesReversedDictionary;this.reversedDictionaryToDatesReversedDictionaryLookup;this.dateInfoReversedDictionary;this.dateInfoHash;this.secondaryDictionary;this.missing=
"Missing";this.dateInfoFields=function(){return{Year:0,"Quarter Number":1,"Quarter Name":2,"Quarter of Year":3,"Month Number":4,"Month Name":5,"Month of Year":6,"Week Number":7,"Week Name":8,"Week Of Year":9,"Day Number of week":10,"Day Name of week":11,Date:12,"Hour of day":13}};this._dictionary;this._reversedDictionary;this.FACT=1;this.DIM=2;this.DATE=3;this.fieldSeparatorSuggestion;this.fieldSeparator;this.lineSeparator;this._lineSeparator;this.lastCharacterOfLineIsFieldSeparator=!1;this.dimCount;
this.factCount;this.lineSamples=50;this.fileSample;this.resultSetKeys;this.resultSetValues;this.RECORD_COUNT_FIELD="# Records";this.getDateInfoDictionary=function(a,b){for(var c=this.fieldNameInfo(a).rawDataIndex,e=this.dateInfoFields()[b],k=this.keyCodes[c],f=this.reversedDictionaryToDatesReversedDictionaryLookup[c],g=this.datesReversedDictionary,d=this.dateInfoReversedDictionary[e],c=this._Array(d.length,!1),p=[],h,l=0;l<k.length;l++)h=k[l],h=g[f[h]].info[e],c[h]||(c[h]=!0,p.push({value:d[h],index:h}));
p.sort(function(a,b){return a.value<b.value?-1:a.value>b.value?1:0});for(e=0;e<p.length;e++)p[e].value=p[e].value.replace(/\{\d+\}/g,"");return{dict:p,entryMap:c}};this.getNetworkFile=function(a){postMessage({reply:"feedback",activity:"Downloading file..."});var b,c=new XMLHttpRequest;c.onprogress=function(a){b=a.loaded/1024;postMessage({reply:"feedback",activity:"Downloading file... Kb's loaded: "+b.toFixed(2)})};c.open("GET",a.name,!1);c.send(null);200===c.status&&(a.fileData=c.responseText,a.size=
a.fileData.length,postMessage({reply:"feedback",activity:"Done downloading file."+(void 0!=b?"Kb's total: "+b.toFixed(2):"")}))};this.sample=function(a){a.isNetworkFile&&this.getNetworkFile(a);var b=0,c=4E3<a.size?4E3:a.size,e,k=new FileReaderSync,f,g,d,p,h,l=0,q="",m,s,r=!1,u={",":0,";":0,"|":0,"\t":0},v={};try{for(;c<=a.size&&l<this.lineSamples;){void 0==a.slice&&void 0==a.isNetworkFile?(e=a.webkitSlice(b,c+1),f=k.readAsText(e)):void 0!=a.slice&&void 0==a.isNetworkFile?(e=a.slice(b,c+1),f=k.readAsText(e)):
a.isNetworkFile&&(f=e=a.fileData.substring(b,c+1));for(g=0;g<f.length;g++){p=d;d=f.charAt(g);0==l&&(r||(d==LF&&p!=CR?(m=LF,s=_LF,r=!0,h=p):d==CR&&(m=CR,s=_CR,r=!0,g<f.length-1&&f.charAt(g+1)==LF&&(m=CRLF,s=_CRLF),h=p)),void 0!=u[d]&&u[d]++,void 0==v[d]?v[d]=1:v[d]++);r&&(s==_LF&&d==LF?l++:s==_CR&&d==CR?l++:s==_CRLF&&d==LF&&p==CR&&l++);if(l==this.lineSamples)break;q+=d}if(l==this.lineSamples)break;b=c+1;c+=c<a.size?4E3:a.size}}catch(y){postMessage({reply:"error",message:y.message})}this.fileSample=
q;this.lineSeparator=m;this._lineSeparator=s;b={character:null,occurences:0};for(d in u)u[d]>b.occurences&&(b.character=d,b.occurences=u[d]);if(0==b.occurences)for(d in b={character:null,occurences:0},v)v[d]>b.occurences&&(b.character=d,b.occurences=v[d]);this.fieldSeparatorSuggestion=b.character;h==this.fieldSeparatorSuggestion&&(this.lastCharacterOfLineIsFieldSeparator=!0);return a};this.initialize=function(a,b,c){this.fieldSeparator=a;this._DimensionOrFactSpec=b;var e=0,k=4E3<c.size?4E3:c.size,
f,g=new FileReaderSync,d,p,h=null,l,q=0,m=!1;a=[];var s="",r=!1,u=this.fieldSeparator,v=this._lineSeparator,m=!1,y=this.lastCharacterOfLineIsFieldSeparator;try{for(;;){postMessage({reply:"progress",activity:"Initializing",message:(100*(e/c.size)).toFixed(1)});void 0==c.slice&&void 0==c.isNetworkFile?(f=c.webkitSlice(e,k+1),d=g.readAsText(f)):void 0!=c.slice&&void 0==c.isNetworkFile?(f=c.slice(e,k+1),d=g.readAsText(f)):c.isNetworkFile&&(d=f=c.fileData.substring(e,k+1));for(p=0;p<d.length;p++){l=h;
h=d.charAt(p);m=!1;if(v==_LF&&h==LF)m=!0;else if(v==_CR&&h==CR)m=!0;else if(v==_CRLF&&h==LF&&l==CR)m=!0;else if(v==_CRLF&&h==CR)continue;0==q&&('"'!=h||"\\"==l||r?'"'==h&&"\\"!=l&&r?r=!1:m?y||a.push(s):h!=u||r?s+=h:(a.push(s),s=""):r=!0);m&&q++}e=k+1;if(k==c.size)break;else k+4E3<c.size?k+=4E3:k+4E3>=c.size&&(k=c.size)}}catch(w){postMessage({reply:"error",message:w.message})}h!=CR&&h!=LF||q--;this.header=a;this.recordCount=q;this.fieldSpec={};this.headerNameToHeaderIndex={};f=c=0;this.compressedDataToRawDataIndexes=
Array(b.length);this.dimensionIndexToHeader=[];this.measureIndexToHeader=[];for(d=0;d<b.length;d++)b[d]==this.DIM||b[d]==this.DATE?(this.dimensionIndexToHeader[c]=a[d],this.compressedDataToRawDataIndexes[d]=c++):b[d]==this.FACT&&(this.measureIndexToHeader[f]=a[d],this.compressedDataToRawDataIndexes[d]=f++),this.fieldSpec[this.header[d]]=b[d],this.headerNameToHeaderIndex[this.header[d]]=d;this.dimCount=c;this.factCount=f;this.keyCodes=this.matrix(this.recordCount,c,"Int32Array");this.values=this.matrix(this.recordCount,
f,"Float32Array");this.valueStats=Array(f);this.dictionary={};this.reversedDictionary={};this.dictionaryLengths={};this.datesReversedDictionary=[];this.reversedDictionaryToDatesReversedDictionaryLookup=[];this._dictionary=[];this._reversedDictionary=[];this.secondaryDictionary={};for(d=0;d<this.header.length;d++)b[d]==this.DIM||b[d]==this.DATE?(this.dictionary[this.header[d]]={},this.reversedDictionary[this.header[d]]=[],this.dictionaryLengths[this.header[d]]=0,this.reversedDictionaryToDatesReversedDictionaryLookup.push([])):
(this.dictionary[this.header[d]]=this.FACT,this.reversedDictionary[this.header[d]]=this.FACT,this.reversedDictionaryToDatesReversedDictionaryLookup[this.header[d]]=this.FACT),this._dictionary.push(this.dictionary[this.header[d]]),this._reversedDictionary.push(this.reversedDictionary[this.header[d]]);for(d=0;d<this.valueStats.length;d++)this.valueStats[d]={max:MIN_INT,min:MAX_INT,mean:0}};this.lpad=function(a,b,c){for(;a.length<b;)a=c+a;return a};this.extractDateMetaInformation=function(){var a=this.datesReversedDictionary;
if(0!=a.length){this.dateInfoReversedDictionary=Array(14);for(var b=0;14>b;b++)this.dateInfoReversedDictionary[b]=[];var c=this.dateInfoReversedDictionary;this.dateInfoHash=Array(14);for(b=0;14>b;b++)this.dateInfoHash[b]={};for(var e=this.dateInfoHash,k=[6,0,1,2,3,4,5],f="Mo Tu We Th Fr Sa Su".split(" "),g="Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec".split(" "),d,p,h=Array(14),l=0;l<a.length;l++){postMessage({reply:"progress",activity:"Extracting date information",message:(100*(l/a.length)).toFixed(1)});
d=a[l];b=moment(d.date);null!=b&&(b.isValid()||(b=moment(d.date,["DD-MMM-YYYY","DD-MMM-YYYY HH:mm:ss"])),p=b.toDate());if(null!=b&&b.isValid())b=""+p.getFullYear(),h[0]=b.substring(2),h[1]=""+Math.floor((p.getMonth()+3)/3),h[2]="Q"+h[1],h[3]="{"+h[0]+this.lpad(""+h[1],2,"0")+"}"+h[2]+" "+h[0],h[4]=this.lpad(""+(p.getMonth()+1),2,"0"),h[5]="{"+h[4]+"}"+g[p.getMonth()],h[6]="{"+h[0]+h[4]+"}"+g[p.getMonth()]+" "+h[0],b=this.lpad(""+this.getWeekNumber(p),2,"0"),h[7]=b,h[8]="Wk"+this.lpad(""+b,2,"0"),
h[9]="{"+h[0]+this.lpad(""+h[7],2,"0")+"}"+h[8]+" "+h[0],h[10]=k[p.getDay()],h[10]=""+(0==h[10]?1:h[10]+1),h[11]="{"+h[10]+"}"+f[h[10]-1],b=""+p.getHours(),h[12]=this.lpad(""+p.getUTCDate(),2,"0")+"-"+g[p.getMonth()]+"-"+p.getFullYear(),h[13]=1==b.length?"0"+b:b;else if(null==b||!b.isValid())for(b=0;b<h.length;b++)h[b]="{999999}Missing";for(b=0;b<h.length;b++)void 0==e[b][h[b]]?(c[b].push(h[b]),d.info[b]=c[b].length-1,e[b][h[b]]=c[b].length-1):d.info[b]=e[b][h[b]]}}};this.getWeekNumber=function(a){a=
new Date(a);a.setHours(0,0,0);a.setDate(a.getDate()+4-(a.getDay()||7));var b=new Date(a.getFullYear(),0,1);return Math.ceil(((a-b)/864E5+1)/7)};this.compress=function(a){for(var b=0,c=3E4<a.size?3E4:a.size,e,k=new FileReaderSync,f,g,d=null,p,h,l=!1,q=this.fieldSeparator,m=-1,s=0,r="",u=this._DimensionOrFactSpec,v=this.header,y=this.reversedDictionary,w=this.datesReversedDictionary,n=this.dictionaryLengths,A=this._dictionary,E=this._reversedDictionary,C=this.missing,G=this.compressedDataToRawDataIndexes,
B=this.reversedDictionaryToDatesReversedDictionaryLookup,t=new Int32Array(this.keyCodes.length),x=0;x<t.length;x++)t[x]=0;for(var t=0,M,K,D,S=this.lastCharacterOfLineIsFieldSeparator,P=this.values,Q=this.keyCodes,N=this.valueStats,F=Array(this.dimCount),L=Array(this.dimCount),x=0;x<L.length;x++)F[x]="",L[x]=-1;var F=x=[],R,L=u[s]==this.DIM?!0:!1,z,I,J,T,O=this._lineSeparator,H=!1;try{for(;;){postMessage({reply:"progress",activity:"Loading file",message:(100*(b/a.size)).toFixed(1)});void 0==a.slice&&
void 0==a.isNetworkFile?(e=a.webkitSlice(b,c+1),f=k.readAsText(e)):void 0!=a.slice&&void 0==a.isNetworkFile?(e=a.slice(b,c+1),f=k.readAsText(e)):a.isNetworkFile&&(f=e=a.fileData.substring(b,c+1));for(g=0;g<f.length;g++){p=d;d=f.charAt(g);H=!1;if(O==_LF&&d==LF)H=!0;else if(O==_CR&&d==CR)H=!0;else if(O==_CRLF&&d==LF&&p==CR)H=!0;else if(O==_CRLF&&d==CR)continue;-1<m?(T=d==q&&!l)||H?(S&&H||(M=A[s],K=E[s],D=G[s],M==this.FACT?""!=r&&(I=parseFloat(r),P[D][m]=I,J=N[D],I<J.min&&(J.min=I),I>J.max&&(J.max=I),
J.mean+=I):(z=F.cd,void 0==z&&(F.cd=[],z=F.cd,u[s]==this.DATE&&(w.push({date:r,info:Array(14)}),z.date=w.length-1)),void 0==z[D]&&(K.push(""!=r?r:C),z[D]=K.length-1,u[s]==this.DATE&&(void 0==z.date&&(w.push({date:r,info:Array(14)}),z.date=w.length-1),B[D].push(z.date))),Q[D][m]=z[D],t++)),s++,r="",H&&(m++,t=s=0),L=u[s]==this.DIM||u[s]==this.DATE?!0:!1,F=x):'"'!=d||"\\"==p||l?'"'==d&&"\\"!=p&&l?l=!1:(r+=d,L&&(h=d,void 0==F[h]?(R=[],F=F[h]=R):F=F[h])):l=!0:-1==m&&H&&m++}b=c+1;if(c==a.size)break;else c+
3E4<a.size?c+=3E4:c+3E4>=a.size&&(c=a.size)}}catch(U){postMessage({reply:"error",message:U.message})}""!=r&&(D=G[s],M=A[s],K=E[s],M==this.FACT?P[D][m]=parseFloat(r):(z=F.cd,void 0==z&&(F.cd=[],z=F.cd,u[s]==this.DATE&&(w.push({date:r,info:Array(14)}),z.date=w.length-1)),void 0==z[D]&&(K.push(r),z[D]=K.length-1,u[s]==this.DATE&&(void 0==z.date&&(w.push({date:r,info:Array(14)}),z.date=w.length-1),B[D].push(z.date))),Q[D][m]=z[D]));for(x=0;x<v.length;x++)if(this._DimensionOrFactSpec[x]==this.DIM||this._DimensionOrFactSpec[x]==
this.DATE)n[v[x]]=y[v[x]].length;for(x=0;x<N.length;x++)N[x].mean/=this.recordCount;this.extractDateMetaInformation();this.setupDictionaries();this.initDB()};this.setupDictionaries=function(){for(var a,b,c=0;c<this.header.length;c++)if(this._DimensionOrFactSpec[c]==this.DIM||this._DimensionOrFactSpec[c]==this.DATE){a=this.dictionary[this.header[c]];b=this.reversedDictionary[this.header[c]];for(var e=0;e<b.length;e++)void 0==a[b[e]]&&(a[b[e]]=e)}this.dictionary[this.header[c]]={};this.reversedDictionary[this.header[c]]=
[]};this.addWordBagDictionary=function(a){for(var b=jsimdb.reversedDictionary[a],c,e,k,f,g={},d=a+" (bag of words)",p=[],h=[],l=0;l<b.length;l++){c=b[l].toLowerCase();k=[];f="";for(var q=0;q<c.length;q++)e=c.charAt(q),void 0!=charPositions[e]?f+=e:" "==e&&""!=f&&(void 0==g[f]?g[f]={count:1,entries:[l],entryHash:{}}:(g[f].count++,void 0==g[f].entryHash[l]&&(g[f].entryHash[l]=g[f].entries.push(l))),k.push(f),f="");""!=f&&(k.push(f),void 0==g[f]?g[f]={count:1,entries:[l],entryHash:{}}:(g[f].count++,
void 0==g[f].entryHash[l]&&(g[f].entryHash[l]=g[f].entries.push(l))))}for(f in g)p.push(f);p.sort();for(l=0;l<p.length;l++)h.push(g[p[l]].entries);this.secondaryDictionary[d]={referencedDictionaryName:a,wordBagDictionary:p,wordBagPointers:h};return this.secondaryDictionary[d].wordBagDictionary};this.entropyCalc=function(a,b){return 0==a?0:-1*a*this._log(a,b)};this.prob=function(a,b){if(0!=b)return a/b;if(0==b)return 0};this.getBestSplit=function(a,b,c,e,k){var f=this.values,g=this.keyCodes,d=this.recordCount,
p=this.fieldNameToRawDataIndex(c),h=this.fieldNameToRawDataIndex(b);b=this.query([{fieldName:b},{fieldName:c}],e,"row_indexes");var l=Array(b.length),q;e=MAX_INT;var m=MIN_INT,s;c=this.dictionaryLengths[c];var r=this._Array(c,0),u=b.length,v;void 0==k?v="regular":void 0!=k&&(v=k);for(k=0;k<b.length;k++)q=b[k],s=f[h][q],l[k]={index:q,value:s,targetValue:g[p][q]},r[g[p][q]]++,s<e&&(e=s),s>m&&(m=s);var f=l.slice(0).sort(function(a,b){return a.value-b.value}),g=this._Array(c,0),p=0,y,w,l=MIN_INT,n,A,
E,C,G;q=0;for(k=1;k<f.length;k++)if(g[f[k-1].targetValue]++,p++,f[k-1].targetValue!=f[k].targetValue){h=u-p;weightedAttributeEntropy=y=s=0;q++;for(var B=0;B<c;B++)w=this.prob(g[B],p),s+=this.entropyCalc(w,2),w=this.prob(r[B]-g[B],h),y+=this.entropyCalc(w,2);s=a-(this.prob(p,u)*s+this.prob(h,u)*y);s>l&&(l=s,n=(f[k-1].value+f[k].value)/2,A=this.prob(p,d),E=this.prob(h,d),C=this.prob(p,u),G=this.prob(h,u))}if("regular"==v)return{splitpoint:n,min:e,max:m,observations:u,informationGain:l,splitsConsidered:q,
lowerBoundSupport:A,upperBoundSupport:E,lowerBoundConfidence:C,upperBoundConfidence:G};if("row_indexes"==v)return{splitpoint:n,min:e,max:m,observations:u,informationGain:l,rowIndexes:b}};this.entropy=function(a,b){for(var c=this.query([{fieldName:a},{fieldName:this.RECORD_COUNT_FIELD}],b,"json_hash"),e,k=0,f=0,f=this.getObservations(c),g=0;g<c.resultSetRowCount;g++)e=this.prob(c.resultSet[g][this.RECORD_COUNT_FIELD],f),k+=this.entropyCalc(e,2);return{entropy:k,observations:f}};this._log=function(a,
b){return Math.log(a)/(b?Math.log(b):1)};this.conditionalEntropy=function(a,b,c){b=this.query([{fieldName:a},{fieldName:b},{fieldName:this.RECORD_COUNT_FIELD}],c,"json_hash");for(var e=0,k={},f={},g=0,d=[],p=[],h=this.recordCount,l=0;l<b.resultSetRowCount;l++)g+=b.resultSet[l][this.RECORD_COUNT_FIELD],void 0==k[b.resultSet[l][a]]&&(k[b.resultSet[l][a]]=0,d.push({branch:b.resultSet[l][a],support:0}),p.push(b.resultSetCoded[l][a])),void 0==f[b.resultSet[l][a]]&&(f[b.resultSet[l][a]]={support:0,confidence:0,
branchIdx:d.length-1}),f[b.resultSet[l][a]].support+=b.resultSet[l][this.RECORD_COUNT_FIELD];for(l=0;l<b.resultSetRowCount;l++)c=this.prob(b.resultSet[l][this.RECORD_COUNT_FIELD],f[b.resultSet[l][a]].support),k[b.resultSet[l][a]]+=this.entropyCalc(c,2);for(var q in f)e+=this.prob(f[q].support,g)*k[q],d[f[q].branchIdx].support=f[q].support/h,d[f[q].branchIdx].confidence=f[q].support/g;return{entropy:e,observations:g,branches:d,branches_coded:p}};this.informationGain=function(a,b,c){this.fieldNameToRawDataIndex(b);
this.fieldNameToRawDataIndex(a);var e=this.fieldSpec[a],k;k=this.entropy(b,c);var f=k.entropy;if(e==this.FACT)return f=this.getBestSplit(f,a,b,c),k=0!=f.splitpoint%1?parseFloat(f.splitpoint).toFixed(1):f.splitpoint,{attribute:a,branches:[{label:"<= "+k,support:f.lowerBoundSupport,confidence:f.lowerBoundConfidence,filter:{type:"measure",from:f.min,to:f.splitpoint}},{label:"> "+k,support:f.upperBoundSupport,confidence:f.upperBoundConfidence,filter:{type:"measure",from:f.splitpoint+0.0010,to:f.max}}],
informationGain:f.informationGain};if(e==this.DIM||e==this.DATE){k=this.conditionalEntropy(a,b,c);b=[];for(c=0;c<k.branches.length;c++)b.push({label:k.branches[c].branch,support:k.branches[c].support,confidence:k.branches[c].confidence,filter:{type:"dimension",entry:k.branches_coded[c],filterOne:!0}});return{attribute:a,branches:b,informationGain:f-k.entropy}}};this.getMostCommonTarget=function(a,b){for(var c,e=0,k={},f=0,g=0;g<a.resultSetRowCount;g++)a.resultSet[g][this.RECORD_COUNT_FIELD]>e&&(e=
a.resultSet[g][this.RECORD_COUNT_FIELD],c=a.resultSet[g][b]),void 0==k[a.resultSet[g][b]]&&(k[a.resultSet[g][b]]=0),f+=a.resultSet[g][this.RECORD_COUNT_FIELD],k[a.resultSet[g][b]]+=a.resultSet[g][this.RECORD_COUNT_FIELD];for(var d in k)k[d]/=f;return{mostCommonTarget:c,classDistribution:k}};this.getObservations=function(a){for(var b=0,c=0;c<a.resultSetRowCount;c++)b+=a.resultSet[c][this.RECORD_COUNT_FIELD];return b};this.ID3=function(a,b,c,e){var k={},f=this.query([{fieldName:a},{fieldName:this.RECORD_COUNT_FIELD}],
c,"json_hash");if(1==f.resultSetRowCount||0==b.length)return k.field=a,k.label=this.getMostCommonTarget(f,a),k;for(var g=MIN_INT,d,p,h,l=0;l<b.length;l++)p=b[l],p=this.informationGain(p,a,c),p.informationGain>g&&(g=p.informationGain,d=p,h=l);k.field=d.attribute;k.branches=d.branches;c=this.copyObject(c);b=b.slice(0);b.splice(h,1);for(l=0;l<d.branches.length;l++)c[k.field]=d.branches[l].filter,h=this.query([{fieldName:a},{fieldName:this.RECORD_COUNT_FIELD}],c,"json_hash"),0==this.getObservations(h)?
(d.branches[l].node={},d.branches[l].node.field=a,d.branches[l].node.label=this.getMostCommonTarget(f,a)):d.branches[l].node=this.ID3(a,b,c,e+1),d.branches[l].node.support=d.branches[l].support;return k};this.extractRules=function(a,b,c){if(void 0==a.branches)c.push({conditions:b.slice(0),consequence:a.field+" = "+a.label.mostCommonTarget,support:a.support,confidence:a.label.classDistribution[a.label.mostCommonTarget]});else for(var e=0;e<a.branches.length;e++)"measure"==a.branches[e].filter.type?
b.push(a.field+" "+a.branches[e].label):"dimension"==a.branches[e].filter.type&&b.push(a.field+" = "+a.branches[e].label),this.extractRules(a.branches[e].node,b,c),b.pop()};this.getDecisionTreeAccuracy=function(a,b){var c=this.values,e=this.keyCodes,k=this.reversedDictionary,f=this.recordCount,g,d,p=this.fieldNameInfo(b);if(void 0!=p){for(var h={},l=0,q=0;q<f;q++){for(g=a;void 0!=g.branches;)if(d=this.fieldNameInfo(g.field),d.type==this.DIM||d.type==this.DATE)for(var m=0;m<g.branches.length;m++){if(g.branches[m].filter.entry==
e[d.rawDataIndex][q]){g=g.branches[m].node;break}}else if(d.type==this.FACT)for(m=0;m<g.branches.length;m++)if(c[d.rawDataIndex][q]>=g.branches[m].filter.from&&c[d.rawDataIndex][q]<=g.branches[m].filter.to){g=g.branches[m].node;break}d=k[b][e[p.rawDataIndex][q]];g=g.label.mostCommonTarget;d==g&&l++;void 0==h[d]&&(h[d]={});void 0==h[d][g]&&(h[d][g]=0);h[d][g]++}for(d in h)for(g in h[d])h[d][g]/=f;return{accuracy:l/f,confusionMatrix:h}}};this.scoreData=function(a,b){for(var c=this.addDimension(b),e=
this.values,k=this.keyCodes,f=this.recordCount,g,d,p={},h=0;h<f;h++){for(g=a;void 0!=g.branches;)if(d=this.fieldNameInfo(g.field),d.type==this.DIM||d.type==this.DATE)for(var l=0;l<g.branches.length;l++){if(g.branches[l].filter.entry==k[d.rawDataIndex][h]){g=g.branches[l].node;break}}else if(d.type==this.FACT)for(l=0;l<g.branches.length;l++)if(e[d.rawDataIndex][h]>=g.branches[l].filter.from&&e[d.rawDataIndex][h]<=g.branches[l].filter.to){g=g.branches[l].node;break}void 0==p[g.label.mostCommonTarget]&&
(p[g.label.mostCommonTarget]=this.addDimensionValue(b,g.label.mostCommonTarget));k[c][h]=p[g.label.mostCommonTarget]}};this.setValueForDimension=function(a,b,c){b=this.addDimensionValue(a,b);a=this.fieldNameInfo(a);a=this.keyCodes[a.rawDataIndex];c=this.query([{fieldName:this.RECORD_COUNT_FIELD}],c,"row_indexes");for(var e=0;e<c.length;e++)a[c[e]]=b.code;return b.isNew};this.addDimensionValue=function(a,b){if(void 0!=this.dictionary[a][b])return{isNew:!1,code:this.dictionary[a][b]};this.reversedDictionary[a].push(b);
this.dictionaryLengths[a]=this.reversedDictionary[a].length;this.dictionary[a][b]=this.reversedDictionary[a].length-1;return{isNew:!0,code:this.reversedDictionary[a].length-1}};this.addDimension=function(a){if(void 0!=this.fieldSpec[a])return-1;this.header.push(a);this._DimensionOrFactSpec.push(this.DIM);this.dimensionIndexToHeader[this.dimCount]=a;this.compressedDataToRawDataIndexes.push(this.dimCount++);this.fieldSpec[a]=this._DimensionOrFactSpec[this._DimensionOrFactSpec.length-1];this.headerNameToHeaderIndex[a]=
this.header.length-1;this.dictionary[a]={};this.reversedDictionary[a]=[];this.dictionaryLengths[a]=0;this.reversedDictionaryToDatesReversedDictionaryLookup.push([]);this._dictionary.push(this.dictionary[a]);this._reversedDictionary.push(this.reversedDictionary[a]);this.keyCodes.push(new Int32Array(this.recordCount));return this.dimCount-1};this.equiWidthBinValue=function(a,b){for(var c=this.values,e=this.keyCodes,k=this.compressedDataToRawDataIndexes[this.headerNameToHeaderIndex[a]],f=this.recordCount,
g=MIN_INT,d=MAX_INT,p=[],h=a+" (equi-binned)",l=this.addDimension(h),q=0;q<f;q++)c[k][q]>g&&(g=c[k][q]),c[k][q]<d&&(d=c[k][q]);for(var m=g=(g-d)/b,q=0;q<b;q++)this.reversedDictionary[h].push(parseFloat(d).toFixed(2)+" - "+parseFloat(m).toFixed(2)),p.push({lower:d,upper:m,count:0}),d=m,m+=g;for(q=0;q<f;q++)d=Math.floor(c[k][q]/g),d==p.length&&d--,p[d].count++,e[l][q]=d;return h};this.getPercentilesByTarget=function(a,b,c,e){var k=this.fieldNameInfo(a),f=this.fieldNameInfo(b),k=this.values[k.rawDataIndex],
f=this.keyCodes[f.rawDataIndex],g=this.reversedDictionary[b],d=this.entropy(b,c);c=this.getBestSplit(d.entropy,a,b,c,"row_indexes");for(var d={},p={},h,l=e=100/e,q=0;q<c.rowIndexes.length;q++)h=c.rowIndexes[q],void 0==d[g[f[h]]]&&(d[g[f[h]]]=[]),d[g[f[h]]].push(k[h]);for(var m in d){d[m].sort(function(a,b){return a-b});k=d[m];p[m]=[];for(f=0;f<k.length;f++)(f+1)/k.length>l/100&&(p[m].push({percentile:l,value:k[f]}),l+=e);p[m].push({percentile:l,value:k[k.length-1]});l=e}return{info:"percentilesByTarget",
valueFieldName:a,targetFieldName:b,percentiles:p,bestSplit:c.splitpoint,bestSplitInformationGain:c.informationGain}};this.binValue=function(a,b){for(var c=this.keyCodes,e=this.compressedDataToRawDataIndexes[this.headerNameToHeaderIndex[a]],k=this.recordCount,f=Array(k),g=0;g<f.length;g++)f[g]={index:g,value:this.values[e][g]};for(var e=f.slice(0).sort(function(a,b){return a.value-b.value}),d=f=100/b,p=Math.round(e[0].value),h=0,l=[],q=a+" (binned)",m=this.addDimension(q),s=0,g=0;g<e.length;g++)h=
100*((g+1)/k),c[m][e[g].index]=s,h>d&&(l.push({percentile:d,value:e[g-1].value,index:e[g-1].index}),d+=f,h=Math.round(e[g-1].value),s=this.reversedDictionary[q].push(p+" - "+h),p=h);h=Math.round(e[k-1].value);this.reversedDictionary[q].push(p+" - "+h);l.push({percentile:d,value:e[k-1].value,index:e[k-1].index});return q};this.initDB=function(){this.resultSetKeys=Array(20);this.resultSetValues=Array(10);for(var a=0;a<this.resultSetKeys.length;a++)this.resultSetKeys[a]=new Int32Array(5E3);for(a=0;a<
this.resultSetValues.length;a++)this.resultSetValues[a]=Array(5E3)};this.getValueStat=function(a){return this.valueStats[this.fieldNameToRawDataIndex(a)]};this.fieldNameToRawDataIndex=function(a){return this.compressedDataToRawDataIndexes[this.headerNameToHeaderIndex[a]]};this.fieldNameInfo=function(a){return void 0==this.fieldSpec[a]?void 0:this.fieldSpec[a]==this.DIM||this.fieldSpec[a]==this.DATE?{type:this.fieldSpec[a],rawDataIndex:this.compressedDataToRawDataIndexes[this.headerNameToHeaderIndex[a]],
cardinality:this.reversedDictionary[a].length}:{type:this.fieldSpec[a],rawDataIndex:this.compressedDataToRawDataIndexes[this.headerNameToHeaderIndex[a]]}};this.query=function(a,b,c){var e=[],k=[],f=[],g=[],d=[],p,h,l=this.keyCodes,q=this.values,m=this.dictionaryLengths,s=this.reversedDictionary,r,u=0,v=[],y=this.resultSetKeys,w=this.resultSetValues,n,A,E,C=0,G=[],B;"html"==c?B=0:"json"==c?B=1:"row_indexes"==c?B=2:"json_column"==c?B=3:"json_hash"==c&&(B=4);for(var C=this.dateInfoFields(),t=0;t<a.length;t++)n=
a[t],this.fieldSpec[n.fieldName]==this.DIM||this.fieldSpec[n.fieldName]==this.DATE?(0==e.length&&(p=Array(m[n.fieldName])),v.push({type:"key",keyType:"directKey",index:e.length})-1,e.push(this.compressedDataToRawDataIndexes[this.headerNameToHeaderIndex[n.fieldName]])-1,k.push({type:"directKey",keyTable:l,fieldDistinctValueCount:m[n.fieldName]})):this.fieldSpec[n.fieldName]==this.FACT?(v.push({type:"value",index:f.length})-1,f.push(this.compressedDataToRawDataIndexes[this.headerNameToHeaderIndex[n.fieldName]])-
1):n.fieldName==this.RECORD_COUNT_FIELD?(v.push({type:"value",index:f.length})-1,f.push(-1)-1):!0==n.dateInfoField?(0==e.length&&(p=Array(this.dateInfoReversedDictionary[C[n.dateInfoFieldName]].length)),v.push({type:"key",keyType:"derivedKey",lookupTable:this.dateInfoReversedDictionary,lookupTableFieldIdx:C[n.dateInfoFieldName],index:e.length})-1,e.push(this.compressedDataToRawDataIndexes[this.headerNameToHeaderIndex[n.dateFieldName]])-1,k.push({type:"derivedKey",joinTable:this.reversedDictionaryToDatesReversedDictionaryLookup,
lookupTable:this.datesReversedDictionary,lookupTableFieldIdx:C[n.dateInfoFieldName],fieldDistinctValueCount:this.dateInfoReversedDictionary[C[n.dateInfoFieldName]].length})):n.isExpression&&v.push({type:"expression",field:n})-1;C=e.length;0==C&&(p=Array(1));for(r in this.secondaryDictionary)if(A=b[r],void 0!=A&&(E=this.secondaryDictionary[r],A.isSecondaryFilter=!0,n=b[E.referencedDictionaryName],void 0==n&&(n={type:"dimension",entries:this._Array(m[E.referencedDictionaryName],!1),allIncluded:A.allIncluded,
filterCount:0,dimensionIndex:this.fieldNameInfo(E.referencedDictionaryName).rawDataIndex},b[E.referencedDictionaryName]=n),0<A.filterCount))for(t=0;t<A.entries.length;t++)if(A.entries[t])for(var x=0;x<E.wordBagPointers[t].length;x++)n.entries[E.wordBagPointers[t][x]]||(n.entries[E.wordBagPointers[t][x]]=!0,n.filterCount++);for(h in b)t=this.fieldNameInfo(h),n=b[h],void 0==n.isSecondaryFilter&&(m={},"dimension"==n.type?(void 0!=t?m.dimensionIndex=t.rawDataIndex:void 0==t&&n.isDateInfoFilter&&(m.dimensionIndex=
this.fieldNameInfo(n.dateFieldName).rawDataIndex,m.isDerived=!0,m.joinColumn=this.reversedDictionaryToDatesReversedDictionaryLookup[m.dimensionIndex],m.lookupTable=this.datesReversedDictionary,m.lookupTableFieldIdx=this.dateInfoFields()[n.dateInfoFieldName]),0<n.filterCount&&n.allIncluded?m.filter=[-3,n.entries]:0<n.filterCount&&!n.allIncluded?m.filter=[-4,n.entries]:0!=n.filterCount||n.allIncluded?0==n.filterCount&&n.allIncluded?m.filter=[-1,null]:n.filterOne&&(m.filter=[-6,n.entry]):m.filter=[-2,
null],g.push(m)):"measure"==n.type&&(m.factIndex=t.rawDataIndex,m.filter=[-5,[n.from,n.to]],d.push(m)));b=new Int32Array(e.length);h=!0;for(t=0;t<this.recordCount;t++){h=!0;for(A=0;A<g.length;A++)if(r=g[A],n=r.filter,m=r.dimensionIndex,-1!=n[0])if(-3==n[0]){if(m=l[m][t],r.isDerived&&(m=r.lookupTable[r.joinColumn[m]].info[r.lookupTableFieldIdx]),n[1][m]){h=!1;break}}else if(-4==n[0])if(m=l[m][t],r.isDerived&&(m=r.lookupTable[r.joinColumn[m]].info[r.lookupTableFieldIdx]),n[1][m])h=!0;else{h=!1;break}else if(-2==
n[0]){h=!1;break}else if(-6==n[0])if(n[1]==l[m][t])h=!0;else{h=!1;break}for(m=0;m<d.length;m++)if(n=d[m].filter,r=d[m].factIndex,r=q[r][t],!(r>=n[1][0]&&r<=n[1][1])){h=!1;break}if(2==B)h&&G.push(t);else if(h){h=p;for(n=0;n<C-1;n++)m=l[e[n]][t],r=k[n],"derivedKey"==r.type&&(m=r.lookupTable[r.joinTable[e[n]][m]].info[r.lookupTableFieldIdx]),b[n]=m,void 0==h[m]&&(h[m]=Array(k[n+1].fieldDistinctValueCount)),h=h[m];0<C?(n=C-1,m=l[e[n]][t],r=k[n],"derivedKey"==r.type&&(m=r.lookupTable[r.joinTable[e[n]][m]].info[r.lookupTableFieldIdx]),
b[n]=m):m=0;if(void 0==h[m])for(h[m]=u,h=u++,n=0;n<f.length;n++)m=f[n],0<=m?w[n][h]=q[m][t]:-1==m&&(w[n][h]=1);else for(h=h[m],n=0;n<f.length;n++)m=f[n],0<=m?w[n][h]+=q[m][t]:-1==m&&(w[n][h]+=1);for(n=0;n<b.length;n++)y[n][h]=b[n]}}if(2==B)return G;root=p;if("html"==c){c="<table><tr>";for(t=0;t<a.length;t++)c+="<td>"+a[t].fieldName+"</td>";c+="</tr>";rsp=v;for(k=0;k<u;k++){c+="<tr>";for(f=0;f<v.length;f++)e=rsp[f],"key"==e.type&&("directKey"==e.keyType?c+="<td>"+s[a[f].fieldName][y[e.index][k]]+"</td>":
"derivedKey"==e.keyType&&(c+="<td>"+e.lookupTable[e.lookupTableFieldIdx][y[e.index][k]]+"</td>")),"value"==e.type&&(c+="<td>"+w[e.index][k]+"</td>");c+="</tr>"}return c+"</table>"}if("json"==c){d=[];g=[];for(t=0;t<a.length;t++)g.push(a[t].fieldName);d.push(g);rsp=v;for(k=0;k<u;k++){g=[];for(f=0;f<v.length;f++)e=rsp[f],"key"==e.type?"directKey"==e.keyType?g.push(s[a[f].fieldName][y[e.index][k]]):"derivedKey"==e.keyType&&g.push(e.lookupTable[e.lookupTableFieldIdx][y[e.index][k]]):"value"==e.type?g.push(w[e.index][k]):
"expression"==e.type&&g.push(e.field.result);d.push(g)}return{resultSet:d,resultSetRowCount:u,outputType:c}}if("json_column"==c){g={};for(t=0;t<a.length;t++)g[a[t].fieldName]=[];rsp=v;for(f=0;f<v.length;f++){e=rsp[f];if("key"==e.type)for(k=0;k<u;k++)"directKey"==e.keyType?g[a[f].fieldName].push(s[a[f].fieldName][y[e.index][k]]):"derivedKey"==e.keyType&&g[a[f].fieldName].push(e.lookupTable[e.lookupTableFieldIdx][y[e.index][k]]);if("value"==e.type)for(k=0;k<u;k++)g[a[f].fieldName].push(w[e.index][k])}return{resultSet:g,
resultSetRowCount:u,outputType:c}}if("json_hash"==c){d=[];p=[];rsp=v;for(k=0;k<u;k++){g={};row_coded={};for(f=0;f<v.length;f++)e=rsp[f],"key"==e.type&&("directKey"==e.keyType?(g[a[f].fieldName]=s[a[f].fieldName][y[e.index][k]],row_coded[a[f].fieldName]=y[e.index][k]):"derivedKey"==e.keyType&&(g[a[f].fieldName]=e.lookupTable[e.lookupTableFieldIdx][y[e.index][k]],row_coded[a[f].fieldName]=y[e.index][k])),"value"==e.type&&(g[a[f].fieldName]=w[e.index][k],row_coded[a[f].fieldName]=w[e.index][k]);d.push(g);
p.push(row_coded)}return{resultSet:d,resultSetCoded:p,resultSetRowCount:u,outputType:c}}};this.getDateInfo=function(a,b,c){return this.datesReversedDictionary[this.reversedDictionaryToDatesReversedDictionaryLookup[fieldIdx][b]][c]};this.listAllData=function(){for(var a="",b=0;b<this.header.length;b++)a+=this.header[b]+";";a=a.substring(0,a.length-1)+"\n";for(b=0;b<this.recordCount;b++){for(var c=0;c<this.compressedDataToRawDataIndexes.length;c++)a=this.fieldSpec[this.header[c]]==this.DIM||this.fieldSpec[this.header[c]]==
this.DATE?a+(this._reversedDictionary[c][this.keyCodes[this.compressedDataToRawDataIndexes[c]][b]]+";"):a+(this.values[this.compressedDataToRawDataIndexes[c]][b]+";");a=a.substring(0,a.length-1)+"\n"}return a};this.getKeys=function(a){var b=[],c;for(c in a)b.push(c);return b};this.matrix=function(a,b,c){for(var e=Array(b),k=0;k<b;k++)"Int32Array"==c?e[k]=new Int32Array(a):"Float32Array"==c&&(e[k]=this._Array(a,0));return e};this._Array=function(a,b){for(var c=Array(a),e=0;e<a;e++)c[e]=b;return c};
this.debug=function(a){postMessage({reply:"debug",message:a})};this.copyObject=function(a){if(null==a||"object"!=typeof a)return a;var b=a.constructor(),c;for(c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b}};
