var dataset,datasetheader,datasetheadernames,explanations={},binnedValues={},GUIfields={},derivedFieldsInfo={},activeMenu=null,menuClickCount=0,imgList,selectedFieldTarget=null,selectedFieldTargetHref=null,jsimdb,timer=new Timer,FACT=1,DIM=2,DATE=3,worker,_file,pivot,_queryResults,_queryResultsCount,filters={},decisionTreeRoot,ruleList,_fileSampleData,_fieldSpec,_lineSeparator,timer=new Timer;function showLoading(){$("#loading").show()}function hideLoading(){$("#loading").hide()}
function clearPivot(){resetSelection();$("#output").html("");pivot.initPivot()}function resetSelection(){$("#rows").html("");$("#columns").html("");$("#measures").html("");GUIfields=[]}function newGUIField(a,b){void 0==GUIfields[a]?(GUIfields[a]=1,void 0!=b&&pivot.addTabularDataHeaderField(a)):GUIfields[a]++;void 0!=b&&(derivedFieldsInfo[a]=b);return a+(1<GUIfields[a]?" "+GUIfields[a]:"")}function removeGUIField(a){void 0!=GUIfields[a]&&GUIfields[a]--}
function getFields(){var a=[];for(field in GUIfields)0<GUIfields[field]&&(void 0!=derivedFieldsInfo[field]?a.push(derivedFieldsInfo[field]):a.push({fieldName:field}));return a}
function selectField(a,b){if(null!=selectedFieldTarget){var c;null!=a?(c=a.replace("lf",""),c=datasetheader[c]):null==a&&void 0!=b&&(c=b.dateInfoFieldName+" ("+b.dateFieldName+")");var e=newGUIField(c,b),l=e.replace(" ",""),k="";"rows"==selectedFieldTarget?(pivot.addRow(c,e),k="menuClickCount++; showDimensionMenu(event, '"+e+"','Row');"):"columns"==selectedFieldTarget?(pivot.addColumn(c,e),k="menuClickCount++; showDimensionMenu(event, '"+e+"','Column');"):"measures"==selectedFieldTarget&&(pivot.addMeasure(c,
e),k="menuClickCount++; showMeasureMenu(event, '"+e+"');");c='<span id="'+l+'"><a href="javascript:void(null)" onclick="'+k+'">'+enclose(e)+"</a></span>";$("#"+selectedFieldTarget).append(c+" ");query(getFields())}}function clearMenu(){null!=activeMenu&&activeMenu.remove()}function addDimension(a,b){worker.postMessage({action:"addDimension",fieldName:a,blankValue:b})}function setFieldValue(a,b){worker.postMessage({action:"setFieldValue",fieldName:a,fieldValue:b,filters:filters})}
function showFieldsMenu(a){clearMenu();activeMenu=a=$('<div class="menu" style="top: '+a.pageY+"; left: "+a.pageX+';"">Add new dimension field called <input type="text" id="newDimName" class="input_text">&nbsp;<a href="javascript:void(null)" onclick="var n = $(\'#newDimName\').val(); if(n == \'\') { alert(\'Please enter a name for the new dimension field.\'); } else { addDimension(n, \'Not Set\'); $(this).parent().remove(); }">Add</a><br></div>');$("body").append(a)}
function showDimensionMenu(a,b,c){clearMenu();activeMenu=a=$('<div class="menu" style="top: '+a.pageY+"; left: "+a.pageX+';" onclick="$(this).remove();"><a href="javascript:void(null)" onclick="pivot.add'+c+"SubTotal('"+b+'\'); doPivot();">Add sub-total</a><br><a href="javascript:void(null)" onclick="pivot.remove'+c+"SubTotal('"+b+'\'); doPivot();">Remove sub-total</a><br><hr><a href="javascript:void(null)" onclick="pivot.remove'+c+"('"+b+"'); $(document.getElementById('"+b.replace(" ","")+"')).remove(); removeGUIField('"+
b+"'); query(getFields());\">Remove</a><br></div>");$("body").append(a)}
function showMeasureMenu(a,b){clearMenu();var c=$('<div class="menu" style="top: '+a.pageY+"; left: "+a.pageX+';" onclick="$(this).remove();"><a href="javascript:void(null)" onclick="pivot.setMeasurePercentageOfRowTotal(\''+b+'\'); doPivot();">% of row total</a><br><a href="javascript:void(null)" onclick="pivot.setMeasurePercentageOfColumnTotal(\''+b+'\'); doPivot();">% of column total</a><br><a href="javascript:void(null)" onclick="pivot.setMeasurePercentageOfPaneTotal(\''+b+'\'); doPivot();">% of pane total</a><br><a href="javascript:void(null)" onclick="pivot.measurePercentageClear(\''+
b+'\'); doPivot();">Clear %-formatting</a><br><hr><a href="javascript:void(null)" onclick="pivot.setMeasureHeatmapRow(\''+b+'\'); doPivot();">Heatmap row</a><br><a href="javascript:void(null)" onclick="pivot.setMeasureHeatmapColumn(\''+b+'\'); doPivot();">Heatmap column</a><br><a href="javascript:void(null)" onclick="pivot.setMeasureHeatmapPane(\''+b+'\'); doPivot();">Heatmap pane</a><br><a href="javascript:void(null)" onclick="pivot.clearMeasureHeatmap(\''+b+'\'); doPivot();">Clear heatmap</a><br><hr><a href="javascript:void(null)" onclick="pivot.removeMeasure(\''+
b+"'); $(document.getElementById('"+b.replace(" ","")+"')).remove(); removeGUIField('"+b+"'); query(getFields());\">Remove</a></div>");activeMenu=c;$("body").append(c)}
function showRowsMenu(a){clearMenu();activeMenu=a=$('<div class="menu" style="top: '+a.pageY+"; left: "+a.pageX+';" onclick="$(this).remove();"><a href="javascript:void(null)" onclick="pivot.addRowTotal(); doPivot();">Add row grand total</a><br><a href="javascript:void(null)" onclick="pivot.removeRowTotal(); doPivot();">Remove row grand total</a></div>');$("body").append(a)}
function showColumnsMenu(a){clearMenu();activeMenu=a=$('<div class="menu" style="top: '+a.pageY+"; left: "+a.pageX+';" onclick="$(this).remove();"><a href="javascript:void(null)" onclick="pivot.addColumnTotal(); doPivot();">Add column grand total</a><br><a href="javascript:void(null)" onclick="pivot.removeColumnTotal(); doPivot();">Remove column grand total</a></div>');$("body").append(a)}
function showMeasuresMenu(a){clearMenu();activeMenu=a=$('<div class="menu" style="top: '+a.pageY+"; left: "+a.pageX+';" onclick="$(this).remove();">Measure header position:<br><a href="javascript:void(null)" onclick="pivot.setMeasureHeaderPlacement(pivot.COLUMN_ABOVE); doPivot();">Above columns</a><br><a href="javascript:void(null)" onclick="pivot.setMeasureHeaderPlacement(pivot.COLUMN_BELOW); doPivot();">Below columns</a><br><a href="javascript:void(null)" onclick="pivot.setMeasureHeaderPlacement(pivot.ROW_ABOVE); doPivot();">Above rows</a><br><a href="javascript:void(null)" onclick="pivot.setMeasureHeaderPlacement(pivot.ROW_BELOW); doPivot();">Below rows</a><br></div>');
$("body").append(a)}
function showMeasuresFieldMenu(a,b){clearMenu();var c=getTargets(b);activeMenu=c=$('<div class="menu" style="top: '+a.pageY+"; left: "+a.pageX+'; display: block;"><a href="javascript:void(null)" onclick="binValue(\''+b+"', 10, 'percentile'); $(this).parent().remove();\">Bin value (percentile)</a><br><a href=\"javascript:void(null)\" onclick=\"binValue('"+b+'\', $(\'#equiWidthBinCount\').val(), \'equi-width\'); $(this).parent().remove();">Bin value (equi-width)</a> &nbsp;Bins:<input type="text" id="equiWidthBinCount" class="input_text" size="2" value="20"><br><a href="javascript:void(null)" onclick="addMeasureFilter(\''+b+
'\'); $(this).parent().remove();">Add filter</a><br><a href="javascript:void(null)" onclick="var e = document.getElementById(\''+c.id+"'); getPercentilesByTarget('"+b+"', e.options[e.selectedIndex].value, 10); $(this).parent().remove();\">Get percentiles by</a>"+c.html+"</div>");$("body").append(c)}
function getTargets(a){a='<select id="selMeasureTarget" class="input_text">';for(var b=0;b<_fieldSpec.length;b++)_fieldSpec[b].dimensionOrFact==this.DIM&&(a+='<option value="'+_fieldSpec[b].field+'">'+_fieldSpec[b].field+"</option>");return{html:a+"</select>",id:"selMeasureTarget"}}function getPercentilesByTarget(a,b,c){worker.postMessage({action:"getPercentilesByTarget",valueFieldName:a,targetFieldName:b,filters:filters,bins:c})}
function showDimensionsFieldMenu(a,b){clearMenu();var c="";if(void 0!=explanations[b])for(var c=c+"<br><u>Explanations</u>",e=0;e<explanations[b].length;e++)c+='<br><a href="javascript:void(null)" onclick="showExplanation(\''+b+"', "+e+'); $(this).parent().remove();">'+explanations[b][e].name+"</a>";activeMenu=c=$('<div class="menu" style="top: '+a.pageY+"; left: "+a.pageX+'; display: block;">Set field value for currently filtered rows. Value: <input type="text" id="fieldLabel" class="input_text"> <a href="javascript:void(null)" onclick="var v = $(\'#fieldLabel\').val(); if(v == \'\') { alert(\'Please enter a field value\'); } else { setFieldValue(\''+
b+'\', v); $(this).parent().remove(); }">Set field value</a><br><a href="javascript:void(null)" onclick="addBagOfWordsFilter(\''+b+'\'); $(this).parent().remove();">Add "bag of words"-filter</a><br><a href="javascript:void(null)" onclick="explainDialog(\''+b+"'); $(this).parent().remove();\">Explain</a>"+c+NaN);$("body").append(c)}function addBagOfWordsFilter(a){worker.postMessage({action:"wordBagFilter",fieldName:a})}
function showExplanation(a,b){$("#explanationDialog_targetConcept").html(a);var c,e='<table cellspacing="1">',l=explanations[a][b].ruleList,k=explanations[a][b].accuracyInfo;c='<table cellspacing="1"><table cellspacing="1"><tr style="background-color: lightGray;"><td style="width: 195px;"><b>Rule conditions</b></td><td style="width: 100px;"><b>Rule consequence</b></td><td style="width: 100px;"><b>Support</b></td><td style="width: 100px;"><b>Confidence</b></td></tr></table>';var g,n,m="<table>";g=
[];for(var f in k.confusionMatrix)g.push(f);m+='<tr style="background-color: lightGray;"><td colspan="2">&nbsp;</td><td colspan="'+g.length+'">Rule conclusion</td></tr>';m+='<tr style="background-color: lightGray;"><td colspan="2">&nbsp;</td>';for(f=0;f<g.length;f++)m+="<td>"+g[f]+"</td>";m+="</tr>";for(f=0;f<g.length;f++){m+="<tr>";0==f&&(m+='<td style="background-color: lightGray;" rowspan="'+g.length+'">Actual</td>');m+='<td style="background-color: lightGray;">'+g[f]+"</td>";for(n=0;n<g.length;n++)m+=
'<td style="text-align: right;">'+(void 0!=k.confusionMatrix[g[f]][g[n]]?parseFloat(100*k.confusionMatrix[g[f]][g[n]]).toFixed(2)+"%":"0%")+"</td>";m+="</tr>"}for(f=0;f<l.length;f++){if(0<l[f].conditions.length)for(g=l[f].conditions[0],n=1;n<l[f].conditions.length;n++)g+="<br>"+l[f].conditions[n];else g="none";n=1==f%2?' style="background-color: #EEEEEE;"':"";e+="<tr"+n+' valign="top"><td style="width: 195px;">'+g+'</td><td style="width: 100px;">'+l[f].consequence+'</td><td style="text-align: right; width: 100px;">'+
parseFloat(100*l[f].support).toFixed(2)+'%</td><td style="text-align: right; width: 100px;">'+parseFloat(100*l[f].confidence).toFixed(2)+"%</td></tr>"}e+="</table>";$("#explanationDialog_ruleListHeader").html(c);$("#explanationDialog_ruleList").html(e);$("#explanationDialog_ruleAccuracy").html(parseFloat(100*k.accuracy).toFixed(2)+"%");$("#explanationDialog_confusionMatrix").html(m);$("#explanationDialog").dialog({height:450,width:534,modal:!0})}
function explainDialog(a){$("#explainDialog_targetConcept").html(a);for(var b="",c=0;c<datasetheader.length;c++)datasetheader[c]!=a&&"# Records"!=datasetheader[c]&&(b+='<input type="checkbox" name="explanatoryAttributes" value="'+datasetheader[c]+'">'+datasetheader[c]+"<br>");$("#explainDialog_explanationName").val("");$("#explainDialog_attributes").html(b);$("#explainDialog").dialog({height:290,width:400,modal:!0})}
function doExplain(){var a=$("#explainDialog_targetConcept").html(),b=[];$.each($("input[name='explanatoryAttributes']"),function(){$(this).prop("checked")&&b.push($(this).prop("value"))});void 0==explanations[a]&&(explanations[a]=[]);explanations[a].push({name:$("#explainDialog_explanationName").val(),attributes:b,decisionTreeRoot:null,ruleList:null,accuracyInfo:null});timer.clearActivity("ID3");timer.begin("ID3");runningTimer=setInterval(function(){timer.end("ID3");$("#info").html("Generating explanation for concept "+
a+"... Time elapsed: "+timer.printActivitySeconds("ID3"));timer.begin("ID3")},20);worker.postMessage({action:"ID3",targetFieldName:a,attributes:b,filters:[]})}function enclose(a){return-1<a.indexOf(" ")?"["+a+"]":a}function displayFilter(a){void 0==filters[a]&&worker.postMessage({action:"getDictionary",fieldName:a})}function displayDateInfoFilter(a,b){void 0==filters[a]&&worker.postMessage({action:"getDateInfoDictionary",fieldName:a,dateInfoFieldName:b})}
function listDataSet(a,b){datasetheader=a.slice(0);datasetheadernames=a.slice(0);datasetheader.push("# Records");datasetheadernames.push("# Records");pivot.setTabularDataHeaderOnly(datasetheadernames,b);for(var c="",e="",l=jsimdb.dateInfoFields,k,g=0;g<datasetheader.length;g++)if(c=jsimdb.fieldSpec[datasetheader[g]]>jsimdb.FACT?'&nbsp;<a href="javascript:void(null)" onclick="displayFilter(\''+datasetheader[g]+'\');"><img src="filter.png"></a>&nbsp;<a href="javascript:void(null)" onclick="menuClickCount++; showDimensionsFieldMenu(event, \''+
datasetheader[g]+"');\">&gt;</a>":jsimdb.fieldSpec[datasetheader[g]]==jsimdb.FACT&&"# Records"!==datasetheadernames[g]?'&nbsp;<a href="javascript:void(null)" onclick="menuClickCount++; showMeasuresFieldMenu(event, \''+datasetheader[g]+"');\">&gt;</a>":"",k=jsimdb.fieldSpec[datasetheader[g]]==DATE?"<a href=\"javascript:void(null)\" onclick=\"$(this).html(($(this).html() == '(+)' ? '(-)' : '(+)')); $('#dateInfo"+g+"').toggle();\">(+)</a>&nbsp;":"",e+="<div>"+k+'<a href="javascript:void(null)" id="lf'+
g+'" onclick="selectField(this.id);">'+datasetheadernames[g]+"</a>"+c+"</div>",jsimdb.fieldSpec[datasetheader[g]]==DATE){var e=e+('<div id="dateInfo'+g+'" style="display: none; background-color: lightGray;">'),c=0,n;for(n in l)k="{'dateInfoField': true,'dateInfoFieldName': '"+n+"','dateFieldName': '"+datasetheader[g]+"','fieldName': '"+n+" ("+datasetheader[g]+")'}",e+=(0<c++?"<br>":"")+'&nbsp;&nbsp;<a href="javascript:void(null)" onclick="selectField(null, '+k+');">'+n+'</a>&nbsp;<a href="javascript:void(null)" onclick="displayDateInfoFilter(\''+
datasetheader[g]+"','"+n+'\');"><img src="filter.png"></a>';e+="</div>"}$("#fields").html(e);$("#loadedDataset").show();hideLoading();showQuickStartGuide()}function preloadImages(){var a="sort.png sort_desc.png sort_asc.png measure.png dimension.png calendar.png filter.png".split(" ");imgList=Array(a.length);for(var b=0;b<a.length;b++)imgList[b]=new Image,imgList[b].src=a[b]}function showSplashScreen(){$("#splash_screen").dialog({height:320,width:300,modal:!0,title:"About"})}
function showQuickStartGuide(){$("#getstarted").dialog({height:250,width:400,modal:!1,title:"Quick Start Guide",top:100,left:400})}function checkForFileParameterInUrl(){var a=document.location.href,b=a.indexOf("?");return-1<b?(a=a.substring(b+1),handleFileSelect(null,a),!0):!1}
function pageInit(){var a=document.getElementById("drop_zone");a.addEventListener?(a.addEventListener("dragover",handleDragOver,!1),a.addEventListener("dragenter",handleDragOver,!1),a.addEventListener("drop",handleFileSelect,!1)):a.attachEvent&&(a.attachEvent("dragover",handleDragOver),a.attachEvent("dragenter",handleDragOver),a.attachEvent("drop",handleFileSelect));$("#fieldSeparator").val("");$("#upload").hide();initPivot();preloadImages();checkForFileParameterInUrl()||showSplashScreen()}
function initPivot(){pivot=new Pivot;pivot._self=pivot;pivot.setPivotPlaceHolder("output");var a=$("#crosstabConfig");pivot.setMeasureHeaderPlacement(pivot.COLUMN_ABOVE);pivot.setHeaderTopPixelOffset(a.offset().top+a.height())}function doPivot(){pivot.transpose();pivot.toHTML();$("#output").html("");$("#output").append(pivot.getHTML())}
function selectFieldTarget(a,b){null!=selectedFieldTargetHref&&selectedFieldTargetHref.css("font-weight","normal");selectedFieldTarget=b;selectedFieldTargetHref=$(a);selectedFieldTargetHref.css("font-weight","bold")}function init(){var a=document.getElementById("drop_zone");a.addEventListener("dragover",handleDragOver,!1);a.addEventListener("dragenter",handleDragOver,!1);a.addEventListener("drop",handleFileSelect,!1);$("#fieldSeparator").val("")}
function createFakeFile(a){return{name:a,size:0,isNetworkFile:!0}}function formatFileName(a){return a='<a target="_blank" href="'+a+'">'+a.substring(0,40)+"...</a>"}
function handleFileSelect(a,b){if(void 0!=a){a.stopPropagation();a.preventDefault();var c=a.dataTransfer.files}else void 0==a&&void 0!=b&&(c=[]);if(0==c.length){var e=createFakeFile(b);c.push(e)}for(var l=0;e=c[l];l++){document.getElementById("list").innerHTML='("'+formatFileName(e.name)+'")';$("#queryPanel").hide();$("#queryResults").html("");$("#fieldSeparator").val("");clearPivot();$("#fields").html("");$("#loadedDataset").hide();worker=new Worker("jsIMDB.min.js");worker.onmessage=function(a){if("query_done"==
a.data.reply)timer.end_na("query"),$("#info").html("Query time: "+timer.printActivity("query")+"."),_queryResults=a.data.query_results,_queryResultsCount=a.data.resultSetRowCount,"json"==a.data.outputType&&(pivot.setTabularDataProjection(a.data.query_results),pivot.transpose(),pivot.toHTML(),$("#output").html(""),$("#output").append(pivot.getHTML()));else if("sample"==a.data.reply)_file=a.data.file,sampleFile(a.data.fileSample,a.data.lineSeparator,a.data.fieldSeparatorSuggestion);else if("progress"==
a.data.reply)$("#info").html(a.data.activity+": "+a.data.message+"%");else if("feedback"==a.data.reply)$("#info").html(a.data.activity);else if("feedback"==a.data.reply)$("#info").html(a.data.message);else if("done_compressing"==a.data.reply)jsimdb=a.data.jsimdb,timer.end_na("compress_data"),$("#info").html("Done loading data in "+timer.printActivity("compress_data")+"."),document.getElementById("list").innerHTML='("'+formatFileName(_file.name)+'", '+jsimdb.recordCount+" rows)",listDataSet(jsimdb.header,
!0),$("#loadedDataset").show();else if("error"==a.data.reply)alert(a.data.message);else if("listAllDataDone"==a.data.reply)$("#output").html("<pre>"+a.data.output+"</pre>");else if("debug"==a.data.reply)console.log(a.data.message);else if("dictionaryListing"==a.data.reply){var b=a.data.dateInfoFieldName,c=a.data.fieldName+(a.data.isDateInfoField?" ("+b+")":""),f=makeIDValid(c);if(void 0==filters[c]){var e,k;a.data.isDateInfoField?(e=a.data.dictionary.dict,k=a.data.dictionary.entryMap):e=a.data.dictionary;
var l,h=6<e.length?" height: 150px;":"",q="dict"+f,r="searchEntryList"+f,t="var "+q+" = [",d;d='<div id="flt'+f+'" class="filterBox" style="left: 300px; top: 300px;">'+('<p style="margin-top: 0px; margin-left: 0px; margin-bottom: 0px; background-color: lightBlue; cursor: move;"><a href="javascript:void(null)" onclick="$(\'#flt'+f+"_listing').toggle(); $(this).html(($(this).html() == '[+]' ? '[-]': '[+]'));\">[-]</a>&nbsp;");d+="<b>"+c+'</b>&nbsp;<a href="javascript:void(null)" onclick="closeFilter(\''+
c+"'); $('#flt"+f+"').remove();\">X</a><br></p>";d+='&nbsp;<input id="fltsearch'+f+'" type="text" size="15">&nbsp;<a href="javascript:void(null)" id="chkSearchCheck'+f+'" onclick="toggleSearchResultCheckBoxes(\''+c+"', "+r+', true)">[x]</a>&nbsp;<a href="javascript:void(null)" id="chkSearchUncheck'+f+'" onclick="toggleSearchResultCheckBoxes(\''+f+"', "+r+', false)">[ ]</a><br></span>';d+='<div id="flt'+f+'_listing" style="white-space: nowrap; display: block; overflow: scroll;'+h+'">';d+='<input id="chkALL'+
f+'" type="checkbox" onchange="toggleFilterListAll(\''+c+"', this.checked);\" checked>All<br>";for(h=0;h<e.length;h++)l=a.data.isDateInfoField?e[h].value:e[h],d+='<span id="flt'+f+h+'"><input id="chk'+f+h+'" type="checkbox" name="'+c+'" onchange="toggleFilterItem(\''+c+"', "+h+', this.checked, true);" checked visible="true" entryID="'+h+'">'+l+"<br></span>",t+="'"+l+"'"+(h<e.length-1?",":"");d+='<script type="text/javascript">';d+="var previousSearchString"+f+" = '';";d+="var trie"+f+" = new Trie(false, false);";
d+=t+"];";d+="var "+r+";";d+="for(var i=0; i<"+q+".length; i++) {";d+="\ttrie"+f+".addString("+q+"[i]);";d+="}";d+="function _c"+f+"() {";d+="\tsearchString = $('#fltsearch"+f+"').val();";d+="\tsearchString = (searchString == undefined ? '' : searchString);";d+="\tif(previousSearchString"+f+" == searchString) return;";d+="\tvar entryList = trie"+f+".query(searchString, false);";d+="\tif(searchString == '') {";d+="\t\tfor(var i=0; i<"+q+".length; i++) {";d+="\t\t\t$('#flt"+f+"' + i).show();";d+="\t\t\t$('#chk"+
f+"' + i).attr('visible', true);";d+="\t\t}";d+="\t\t"+r+" = [];";d+="\t\tpreviousSearchString"+f+" = searchString;";d+="\t\treturn;";d+=" }";d+="\tif(entryList.length > 0) {";d+="\t\tfor(var i=0; i<"+q+".length; i++) {";d+="\t\t\t$('#flt"+f+"' + i).hide();";d+="\t\t\t$('#chk"+f+"' + i).attr('visible', false);";d+="\t\t}";d+="\t\t"+r+" = entryList;";d+="\t\tfor(var i in entryList) {";d+="\t\t\t$('#flt"+f+"' + entryList[i].entryID).show();";d+="\t\t\t$('#chk"+f+"' + entryList[i].entryID).attr('visible', true);";
d+="\t\t}";d+="\t} else if(entryList.length == 0) {";d+="\t\tfor(var i=0; i<"+q+".length; i++) {";d+="\t\t\t$('#flt"+f+"' + i).hide();";d+="\t\t\t$('#chk"+f+"' + i).attr('visible', false);";d+="\t\t}";d+="\t\t"+r+" = entryList;";d+="\t}";d+="\tpreviousSearchString"+f+" = searchString;";d+="}";d+="setInterval(_c"+f+", 100);";d+="\x3c/script>";d+="</div></div>";$("body").append(d);$("#flt"+f).draggable({handle:"p"});filters[c]={type:"dimension",entries:a.data.isDateInfoField?_Array(k.length,!1):_Array(e.length,
!1),allIncluded:!0,filterCount:0};a.data.isDateInfoField&&(filters[c].dateFieldName=a.data.fieldName,filters[c].dateInfoFieldName=b,filters[c].isDateInfoFilter=!0,filters[c].filterIndexLookup=e)}}else if("binValue"==a.data.reply)jsimdb.header=a.data.header,jsimdb.fieldSpec=a.data.fieldSpec,listDataSet(jsimdb.header,!1),clearPivot();else if("valueStat"==a.data.reply)c=a.data.fieldName,f=a.data.fieldName.replace(/\s|\(|\)/g,""),h=a.data.valueStat,d='<div id="flt'+f+'" class="filterBox" style="left: 300px; top: 300px;">'+
('<p style="margin-top: 0px; margin-left: 0px; margin-bottom: 0px; background-color: lightBlue; cursor: move;"><a href="javascript:void(null)" onclick="$(\'#flt'+f+"_listing').toggle(); $(this).html(($(this).html() == '[+]' ? '[-]': '[+]'));\">[-]</a>&nbsp;"),d+="<b>"+c+'</b>&nbsp;<a href="javascript:void(null)" onclick="closeFilter(\''+c+"'); $('#flt"+f+"').remove();\">X</a><br></p>",d+='<div id="flt'+f+'_listing" style="white-space: nowrap; display: block; overflow: scroll; height: 60px;">',d+=
'<div id="sld'+f+'"></div><br><div id="sldlbl'+f+'"></div>',d+="</div></div>",$("body").append(d),$("#flt"+f).draggable({handle:"p"}),$("#sldlbl"+f).html(h.min+" - "+h.max),filters[c]={type:"measure",from:h.min,to:h.max},a=1,1>Math.abs(h.min)&&1>Math.abs(h.max)&&(a=0.01),$("#sld"+f).slider({range:!0,min:h.min,max:h.max,step:a,values:[h.min,h.max],slide:function(a,b){$("#sldlbl"+f).html(b.values[0]+" - "+b.values[1])},stop:function(a,b){filters[c].from=b.values[0];filters[c].to=b.values[1];query(getFields())}});
else if("ID3"==a.data.reply)decisionTreeRoot=a.data.decisionTreeRoot,window.clearInterval(runningTimer),$("#info").html("Done generating explanation for concept "+$("#explainDialog_targetConcept").html()+" in "+timer.printActivitySeconds("ID3")),h=explanations[a.data.targetFieldName][explanations[a.data.targetFieldName].length-1],h.decisionTreeRoot=a.data.decisionTreeRoot,worker.postMessage({action:"extractRules",decisionTreeRoot:decisionTreeRoot,targetFieldName:a.data.targetFieldName});else if("scoreData"==
a.data.reply)console.log("Data has been scored."),jsimdb.header=a.data.header,jsimdb.fieldSpec=a.data.fieldSpec,listDataSet(jsimdb.header,!1),clearPivot();else if("extractRules"==a.data.reply)ruleList=a.data.ruleList,h=explanations[a.data.targetFieldName][explanations[a.data.targetFieldName].length-1],h.ruleList=a.data.ruleList,worker.postMessage({action:"getDecisionTreeAccuracy",decisionTreeRoot:decisionTreeRoot,targetFieldName:a.data.targetFieldName});else if("decisionTreeAccuracy"==a.data.reply)h=
explanations[a.data.targetFieldName][explanations[a.data.targetFieldName].length-1],h.accuracyInfo=a.data.accuracyInfo;else if("percentilesByTarget"==a.data.reply){a=a.data.payload;k=[];b=0;for(d in a.percentiles){for(h=0;h<a.percentiles[d].length;h++)e={},e[a.targetFieldName]=d,e.Percentile=a.percentiles[d][h].percentile,e[a.valueFieldName]=a.percentiles[d][h].value,k.push(e),0==b&&(e={},e[a.targetFieldName]="Best split",e.Percentile=a.percentiles[d][h].percentile,e[a.valueFieldName]=a.bestSplit,
k.push(e));b++}$("#output").html("");h=dimple.newSvg("#output",420,300);h=new dimple.chart(h,k);h.setBounds(50,30,370,220);h.addCategoryAxis("x","Percentile").addOrderRule("Percentile");h.addMeasureAxis("y",a.valueFieldName);h.addSeries(a.targetFieldName,dimple.plot.line).lineMarkers=!0;h.addLegend(60,10,300,20,"right");h.draw()}else"addDimension"==a.data.reply?"OK"==a.data.status?(jsimdb.header=a.data.header,jsimdb.fieldSpec=a.data.fieldSpec,listDataSet(jsimdb.header,!1),clearPivot()):alert(a.data.status):
"setFieldValue"==a.data.reply&&(query(getFields()),a.data.isNew&&addFilterEntry(a.data.fieldName,a.data.fieldValue))};_file=e;try{$("#hrefListAllData").hide(),worker.postMessage({action:"sample",file:e})}catch(k){alert(k)}}}function makeIDValid(a){return a.replace(/\s|\(|\)/g,"")}
function addFilterEntry(a,b){if(void 0!=filters[a]){eval("trie"+a+".addString('"+b+"')");eval("dict"+a+".push('"+b+"')");var c=filters[a].entries.push(!filters[a].allIncluded)-1;filters[a].filterCount++;$("#flt"+a+"_listing").append('<span id="flt'+a+c+'" style="display: inline;"><input id="chk'+a+c+'" type="checkbox" name="'+a+'" onchange="toggleFilterItem(\''+a+"', "+c+', this.checked, true);" checked visible="true" entryID="'+c+'">'+b+"<br></span>")}}
function addMeasureFilter(a){worker.postMessage({action:"getValueStat",fieldName:a})}function _Array(a,b){for(var c=Array(a),e=0;e<a;e++)c[e]=b;return c}function toggleSearchResultCheckBoxes(a,b,c){if(void 0!=b){for(var e=makeIDValid(a),l=0;l<b.length;l++)$("#chk"+e+b[l].entryID).prop("checked",c),toggleFilterItem(a,b[l].entryID,c,!1);query(getFields())}}
function toggleFilterListAll(a,b){filters[a].allIncluded=b;$.each($("input[name='"+a+"']"),function(){$(this).prop("checked",b)});filters[a].entries=_Array(filters[a].entries.length,!1);filters[a].filterCount=0;query(getFields())}
function toggleFilterItem(a,b,c,e){a=filters[a];b=a.isDateInfoFilter?a.filterIndexLookup[b].index:b;if(c&&!a.allIncluded||!c&&a.allIncluded)a.entries[b]=!0,a.filterCount++;else if(c&&a.allIncluded||!c&&!a.allIncluded)a.entries[b]=!1,a.filterCount--;e&&query(getFields())}function closeFilter(a){delete filters[a];query(getFields())}
function readFile(){var a=[],b=$("#fieldSeparator").val();"\\t"==b&&(b="\t");for(var c=0;c<_fieldSpec.length;c++)a.push(_fieldSpec[c].dimensionOrFact);$("#fileSamplePanel").hide();$("#readFilePanel").hide();timer.begin("compress_data");worker.postMessage({action:"compress",file:_file,fieldSeparator:b,dimensionOrFactSpec:a})}
function sampleFile(a,b,c){_lineSeparator=void 0!=b?b:_lineSeparator;void 0!=c?("\t"==c?$("#fieldSeparator").val("\\t"):$("#fieldSeparator").val(c),b=c):(b=$("#fieldSeparator").val(),"\\t"==b&&(b="\t"));_fileSampleData=a;a=a.split(_lineSeparator);c="";if(""==b){c+="<table>";for(var e=0;e<a.length;e++)c+="<tr "+(0==e?'style="background-color: lightGray; font-weight: bold;"':"")+"><td>"+a[e]+"</td></tr>";c+="</table>"}else if(""!=b){var l=null,k,g="",n=[],m=0,f=!1,s=0;a[0].charAt(a[0].length-1)==b&&
(s=b.length);c+="<table>";for(e=0;e<a.length;e++){g="";m=0;f=!1;c+="<tr "+(0==e?'style="background-color: lightGray; font-weight: bold;"':"")+">";for(var p=0;p<a[e].length-s;p++)l=k,k=a[e].charAt(p),p!=a[e].length-1-s||f||k==b||(g+=k),p==a[e].length-1-s&&f&&'"'==k&&(k="",f=!1),'"'!=k||"\\"==l||f?'"'==k&&"\\"!=l&&f?f=!1:k==b&&!f||p==a[e].length-1-s?(0==e?(n.push({field:g,dimensionOrFact:-1}),c+='<td><a id="fieldSpec'+m+'" href="javascript:void(null)" onclick="toggleFieldType(this.id);">'+g+"</a></td>"):
(c+="<td>"+g+"</td>",isDate(g)?-1==n[m].dimensionOrFact&&(n[m].dimensionOrFact=DATE):isNumber(g)?-1==n[m].dimensionOrFact&&(n[m].dimensionOrFact=FACT):n[m].dimensionOrFact=DIM),g="",m++):g+=k:f=!0;c+="</tr>"}c+="</table>"}_fieldSpec=n;$("#upload").dialog({height:500,width:700,modal:!0});$("#fileSampleContents").html(c);$("#fileSamplePanel").show();""!=b&&(displayFieldSpec(),$("#readFilePanel").show(),$("#fileSampleContents").show())}
function displayFieldSpec(){for(var a=0;a<_fieldSpec.length;a++)_fieldSpec[a].dimensionOrFact==FACT?$("#fieldSpec"+a).html($("#fieldSpec"+a).html()+' <img src="measure.png">'):_fieldSpec[a].dimensionOrFact==DIM?$("#fieldSpec"+a).html($("#fieldSpec"+a).html()+' <img src="dimension.png">'):_fieldSpec[a].dimensionOrFact==DATE&&$("#fieldSpec"+a).html($("#fieldSpec"+a).html()+' <img src="calendar.png">')}
function toggleFieldType(a){var b=parseInt(a.replace("fieldSpec",""));_fieldSpec[b].dimensionOrFact==FACT?($("#"+a).html(_fieldSpec[b].field+' <img src="dimension.png">'),_fieldSpec[b].dimensionOrFact=DIM):_fieldSpec[b].dimensionOrFact==DIM?($("#"+a).html(_fieldSpec[b].field+' <img src="calendar.png">'),_fieldSpec[b].dimensionOrFact=DATE):_fieldSpec[b].dimensionOrFact==DATE&&($("#"+a).html(_fieldSpec[b].field+' <img src="measure.png">'),_fieldSpec[b].dimensionOrFact=FACT)}
function isNumber(a){return!isNaN(parseFloat(a))&&isFinite(a)}function handleDragOver(a){a.stopPropagation();a.preventDefault();a.dataTransfer.dropEffect="copy"}function query(a,b){if(void 0!=a)if(0==a.length)$("#output").html("");else{var c=void 0==b?"json":b;timer.begin("query");worker.postMessage({action:"query",outputType:c,fields:a,filters:filters})}}
function binValue(a,b,c){void 0==binnedValues[a]&&void 0==binnedValues[a]&&(binnedValues[a]=!0,worker.postMessage({action:"binValue",field:a,binCount:b,binType:c}))};
